package services

import (
	"errors"
	"log"
	"time"

	"yunmeng-backend/models"

	"gorm.io/gorm"
)

type ProjectService struct {
	db *gorm.DB
}

func NewProjectService(db *gorm.DB) *ProjectService {
	return &ProjectService{db: db}
}

// GetProjectList è·å–é¡¹ç›®åˆ—è¡¨
func (s *ProjectService) GetProjectList(params models.ProjectQueryParams) ([]models.ProjectListResponse, int64, error) {
	var projects []models.Project
	var total int64

	// æ„å»ºæŸ¥è¯¢
	query := s.db.Model(&models.Project{}).
		Preload("Student.Profile").
		Preload("Teacher.Profile").
		Preload("Members").
		Preload("Files").
		Preload("Reviews")

	// æœç´¢æ¡ä»¶
	if params.Search != "" {
		search := "%" + params.Search + "%"
		query = query.Where("projects.title LIKE ? OR projects.description LIKE ?", search, search)
	}

	// ç±»å‹ç­›é€?
	if params.Type != "" {
		query = query.Where("projects.type = ?", params.Type)
	}

	// çŠ¶æ€ç­›é€?
	if params.Status != "" {
		query = query.Where("projects.status = ?", params.Status)
	}

	// å­¦ç”ŸIDç­›é€?
	if params.StudentID > 0 {
		query = query.Where("projects.student_id = ?", params.StudentID)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		log.Printf("è·å–é¡¹ç›®æ€»æ•°å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// æ’åº
	if params.SortBy != "" {
		order := params.SortBy
		if params.SortOrder == "desc" {
			order += " DESC"
		}
		query = query.Order(order)
	} else {
		query = query.Order("projects.created_at DESC")
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Find(&projects).Error; err != nil {
		log.Printf("æŸ¥è¯¢é¡¹ç›®åˆ—è¡¨å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// è½¬æ¢ä¸ºå“åº”æ ¼å¼?
	var responses []models.ProjectListResponse
	for _, project := range projects {
		response := models.ProjectListResponse{
			ID:          project.ID,
			Title:       project.Title,
			Description: project.Description,
			Type:        project.Type,
			Status:      project.Status,
			TeacherID:   project.TeacherID,
			SubmittedAt: project.SubmittedAt,
			CreatedAt:   project.CreatedAt,
			UpdatedAt:   project.UpdatedAt,
			MemberCount: len(project.Members),
			FileCount:   len(project.Files),
			ReviewCount: len(project.Reviews),
		}

		// æ·»åŠ å­¦ç”Ÿä¿¡æ¯
		if project.Student != nil && project.Student.Profile != nil {
			response.StudentName = project.Student.Profile.RealName
			response.StudentID = project.Student.Profile.StudentID
		}

		// æ·»åŠ æ•™å¸ˆä¿¡æ¯
		if project.Teacher != nil && project.Teacher.Profile != nil {
			response.TeacherName = project.Teacher.Profile.RealName
		}

		responses = append(responses, response)
	}

	log.Printf("é¡¹ç›®åˆ—è¡¨æŸ¥è¯¢å®Œæˆ - æ€»æ•°: %d, è¿”å›æ•°é‡: %d", total, len(responses))
	return responses, total, nil
}

// GetProjectByID æ ¹æ®IDè·å–é¡¹ç›®è¯¦æƒ…
func (s *ProjectService) GetProjectByID(id uint) (*models.ProjectDetailResponse, error) {
	var project models.Project
	err := s.db.Preload("Student.Profile").
		Preload("Teacher.Profile").
		Preload("Members").
		Preload("Files").
		Preload("Reviews.Reviewer.Profile").
		First(&project, id).Error
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		log.Printf("æŸ¥è¯¢é¡¹ç›®è¯¦æƒ…å¤±è´¥ - é¡¹ç›®ID: %d, é”™è¯¯: %v", id, err)
		return nil, err
	}

	// æ„å»ºå“åº”æ•°æ®
	response := &models.ProjectDetailResponse{
		ID:          project.ID,
		Title:       project.Title,
		Description: project.Description,
		Type:        project.Type,
		Status:      project.Status,
		SubmittedAt: project.SubmittedAt,
		CreatedAt:   project.CreatedAt,
		UpdatedAt:   project.UpdatedAt,
	}

	// æ·»åŠ å­¦ç”Ÿä¿¡æ¯
	if project.Student != nil && project.Student.Profile != nil {
		response.Student.ID = project.Student.ID
		response.Student.Username = project.Student.Username
		response.Student.RealName = project.Student.Profile.RealName
		response.Student.Email = project.Student.Email
		response.Student.Phone = project.Student.Profile.Phone
		response.Student.Department = project.Student.Profile.Department
		response.Student.StudentID = project.Student.Profile.StudentID
	}

	// æ·»åŠ æ•™å¸ˆä¿¡æ¯
	if project.Teacher != nil && project.Teacher.Profile != nil {
		response.Teacher.ID = project.Teacher.ID
		response.Teacher.Username = project.Teacher.Username
		response.Teacher.RealName = project.Teacher.Profile.RealName
		response.Teacher.Email = project.Teacher.Email
		response.Teacher.Phone = project.Teacher.Profile.Phone
		response.Teacher.Department = project.Teacher.Profile.Department
	}

	// æ·»åŠ æˆå‘˜ä¿¡æ¯
	for _, member := range project.Members {
		response.Members = append(response.Members, struct {
			ID            uint   `json:"id"`
			Name          string `json:"name"`
			StudentNumber string `json:"studentNumber"`
			Role          string `json:"role"`
		}{
			ID:            member.ID,
			Name:          member.Name,
			StudentNumber: member.StudentNumber,
			Role:          member.Role,
		})
	}

	// æ·»åŠ æ–‡ä»¶ä¿¡æ¯
	for _, file := range project.Files {
		response.Files = append(response.Files, struct {
			ID         uint      `json:"id"`
			FileName   string    `json:"fileName"`
			FileURL    string    `json:"fileUrl"`
			UploadTime time.Time `json:"uploadTime"`
		}{
			ID:         file.ID,
			FileName:   file.FileName,
			FileURL:    file.FileURL,
			UploadTime: file.UploadTime,
		})
	}

	// æ·»åŠ å®¡æ ¸ä¿¡æ¯
	for _, review := range project.Reviews {
		reviewInfo := struct {
			ID         uint      `json:"id"`
			Status     string    `json:"status"`
			Comments   string    `json:"comments"`
			ReviewTime time.Time `json:"reviewTime"`
			Reviewer   struct {
				ID       uint   `json:"id"`
				Username string `json:"username"`
				RealName string `json:"realName"`
			} `json:"reviewer"`
		}{
			ID:         review.ID,
			Status:     review.Status,
			Comments:   review.Comments,
			ReviewTime: review.ReviewTime,
		}

		if review.Reviewer != nil && review.Reviewer.Profile != nil {
			reviewInfo.Reviewer.ID = review.Reviewer.ID
			reviewInfo.Reviewer.Username = review.Reviewer.Username
			reviewInfo.Reviewer.RealName = review.Reviewer.Profile.RealName
		}

		response.Reviews = append(response.Reviews, reviewInfo)
	}

	log.Printf("é¡¹ç›®è¯¦æƒ…æŸ¥è¯¢å®Œæˆ - é¡¹ç›®ID: %d, æ ‡é¢˜: %s", id, project.Title)
	return response, nil
}

// CreateProject åˆ›å»ºé¡¹ç›®
func (s *ProjectService) CreateProject(studentID uint, req models.ProjectCreateRequest) (*models.ProjectCreateResponse, error) {
	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// åˆ›å»ºé¡¹ç›®
	project := models.Project{
		Title:       req.Title,
		Description: req.Description,
		Type:        req.Type,
		Status:      req.Status,
		StudentID:   studentID,
		TeacherID:   req.TeacherID,
	}

	if err := tx.Create(&project).Error; err != nil {
		tx.Rollback()
		log.Printf("åˆ›å»ºé¡¹ç›®å¤±è´¥: %v", err)
		return nil, errors.New("åˆ›å»ºé¡¹ç›®å¤±è´¥")
	}

	// åˆ›å»ºé¡¹ç›®æˆå‘˜
	for _, memberReq := range req.Members {
		member := models.ProjectMember{
			ProjectID:     project.ID,
			Name:          memberReq.Name,
			StudentNumber: memberReq.StudentNumber,
			Role:          memberReq.Role,
		}

		if err := tx.Create(&member).Error; err != nil {
			tx.Rollback()
			log.Printf("åˆ›å»ºé¡¹ç›®æˆå‘˜å¤±è´¥: %v", err)
			return nil, errors.New("åˆ›å»ºé¡¹ç›®æˆå‘˜å¤±è´¥")
		}
	}

	// åˆ›å»ºé¡¹ç›®é™„ä»¶
	for _, fileReq := range req.Attachments {
		file := models.ProjectFile{
			ProjectID: project.ID,
			FileName:  fileReq.FileName,
			FileURL:   fileReq.FileURL,
		}

		if err := tx.Create(&file).Error; err != nil {
			tx.Rollback()
			log.Printf("åˆ›å»ºé¡¹ç›®é™„ä»¶å¤±è´¥: %v", err)
			return nil, errors.New("åˆ›å»ºé¡¹ç›®é™„ä»¶å¤±è´¥")
		}
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return nil, errors.New("åˆ›å»ºé¡¹ç›®å¤±è´¥")
	}

	log.Printf("é¡¹ç›®åˆ›å»ºæˆåŠŸ - é¡¹ç›®ID: %d, æ ‡é¢˜: %s", project.ID, project.Title)
	return &models.ProjectCreateResponse{ProjectID: project.ID}, nil
}

// UpdateProject æ›´æ–°é¡¹ç›®
func (s *ProjectService) UpdateProject(id uint, studentID uint, req models.ProjectUpdateRequest) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, id).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// æ£€æŸ¥æƒé™ï¼šåªæœ‰é¡¹ç›®åˆ›å»ºè€…å¯ä»¥ä¿®æ”?
	if project.StudentID != studentID {
		return errors.New("æ— æƒé™ä¿®æ”¹æ­¤é¡¹ç›®")
	}

	// æ£€æŸ¥çŠ¶æ€ï¼šåªæœ‰è‰ç¨¿æˆ–å·²é©³å›çŠ¶æ€çš„é¡¹ç›®å¯ä»¥ä¿®æ”¹
	if project.Status != "draft" && project.Status != "rejected" {
		return errors.New("åªæœ‰è‰ç¨¿æˆ–å·²é©³å›çŠ¶æ€çš„é¡¹ç›®å¯ä»¥ä¿®æ”¹")
	}

	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// æ›´æ–°é¡¹ç›®åŸºæœ¬ä¿¡æ¯
	updates := make(map[string]interface{})
	if req.Title != "" {
		updates["title"] = req.Title
	}
	if req.Description != "" {
		updates["description"] = req.Description
	}
	if req.Type != "" {
		updates["type"] = req.Type
	}
	if req.Status != "" {
		updates["status"] = req.Status
	}
	if req.TeacherID > 0 {
		updates["teacher_id"] = req.TeacherID
	}

	if len(updates) > 0 {
		if err := tx.Model(&project).Updates(updates).Error; err != nil {
			tx.Rollback()
			log.Printf("æ›´æ–°é¡¹ç›®å¤±è´¥: %v", err)
			return errors.New("æ›´æ–°é¡¹ç›®å¤±è´¥")
		}
	}

	// æ›´æ–°é¡¹ç›®æˆå‘˜
	if req.Members != nil {
		// åˆ é™¤ç°æœ‰æˆå‘˜
		if err := tx.Where("project_id = ?", id).Delete(&models.ProjectMember{}).Error; err != nil {
			tx.Rollback()
			log.Printf("åˆ é™¤é¡¹ç›®æˆå‘˜å¤±è´¥: %v", err)
			return errors.New("æ›´æ–°é¡¹ç›®æˆå‘˜å¤±è´¥")
		}

		// åˆ›å»ºæ–°æˆå‘?
		for _, memberReq := range req.Members {
			member := models.ProjectMember{
				ProjectID:     id,
				Name:          memberReq.Name,
				StudentNumber: memberReq.StudentNumber,
				Role:          memberReq.Role,
			}

			if err := tx.Create(&member).Error; err != nil {
				tx.Rollback()
				log.Printf("åˆ›å»ºé¡¹ç›®æˆå‘˜å¤±è´¥: %v", err)
				return errors.New("æ›´æ–°é¡¹ç›®æˆå‘˜å¤±è´¥")
			}
		}
	}

	// æ›´æ–°é¡¹ç›®æ–‡ä»¶
	if req.Files != nil {
		// åˆ é™¤ç°æœ‰æ–‡ä»¶
		if err := tx.Where("project_id = ?", id).Delete(&models.ProjectFile{}).Error; err != nil {
			tx.Rollback()
			log.Printf("åˆ é™¤é¡¹ç›®æ–‡ä»¶å¤±è´¥: %v", err)
			return errors.New("æ›´æ–°é¡¹ç›®æ–‡ä»¶å¤±è´¥")
		}

		// åˆ›å»ºæ–°æ–‡ä»?
		for _, fileReq := range req.Files {
			file := models.ProjectFile{
				ProjectID: id,
				FileName:  fileReq.FileName,
				FileURL:   fileReq.FileURL,
			}

			if err := tx.Create(&file).Error; err != nil {
				tx.Rollback()
				log.Printf("åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤±è´¥: %v", err)
				return errors.New("æ›´æ–°é¡¹ç›®æ–‡ä»¶å¤±è´¥")
			}
		}
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return errors.New("æ›´æ–°é¡¹ç›®å¤±è´¥")
	}

	log.Printf("é¡¹ç›®æ›´æ–°æˆåŠŸ - é¡¹ç›®ID: %d", id)
	return nil
}

// DeleteProject åˆ é™¤é¡¹ç›®
func (s *ProjectService) DeleteProject(id uint) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, id).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// æ£€æŸ¥çŠ¶æ€ï¼šåªæœ‰è‰ç¨¿æˆ–å·²é©³å›çŠ¶æ€çš„é¡¹ç›®å¯ä»¥åˆ é™¤
	if project.Status != "draft" && project.Status != "rejected" {
		return errors.New("åªæœ‰è‰ç¨¿æˆ–å·²é©³å›çŠ¶æ€çš„é¡¹ç›®å¯ä»¥åˆ é™¤")
	}

	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// åˆ é™¤é¡¹ç›®ï¼ˆå…³è”æ•°æ®ä¼šé€šè¿‡CASCADEè‡ªåŠ¨åˆ é™¤ï¼?
	if err := tx.Delete(&project).Error; err != nil {
		tx.Rollback()
		log.Printf("åˆ é™¤é¡¹ç›®å¤±è´¥: %v", err)
		return errors.New("åˆ é™¤é¡¹ç›®å¤±è´¥")
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return errors.New("åˆ é™¤é¡¹ç›®å¤±è´¥")
	}

	log.Printf("é¡¹ç›®åˆ é™¤æˆåŠŸ - é¡¹ç›®ID: %d", id)
	return nil
}

// ReviewProject å®¡æ ¸é¡¹ç›®
func (s *ProjectService) ReviewProject(projectID uint, reviewerID uint, req models.ProjectReviewRequest) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// åˆ›å»ºå®¡æ ¸è®°å½•
	review := models.ProjectReview{
		ProjectID:  projectID,
		ReviewerID: reviewerID,
		Status:     req.Status,
		Comments:   req.Comments,
	}

	if err := tx.Create(&review).Error; err != nil {
		tx.Rollback()
		log.Printf("åˆ›å»ºå®¡æ ¸è®°å½•å¤±è´¥: %v", err)
		return errors.New("åˆ›å»ºå®¡æ ¸è®°å½•å¤±è´¥")
	}

	// æ›´æ–°é¡¹ç›®çŠ¶æ€?
	if err := tx.Model(&project).Update("status", req.Status).Error; err != nil {
		tx.Rollback()
		log.Printf("æ›´æ–°é¡¹ç›®çŠ¶æ€å¤±è´? %v", err)
		return errors.New("æ›´æ–°é¡¹ç›®çŠ¶æ€å¤±è´?)
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return errors.New("å®¡æ ¸é¡¹ç›®å¤±è´¥")
	}

	log.Printf("é¡¹ç›®å®¡æ ¸å®Œæˆ - é¡¹ç›®ID: %d, å®¡æ ¸ç»“æœ: %s", projectID, req.Status)
	return nil
}

// GetProjectStats è·å–é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
func (s *ProjectService) GetProjectStats() (*models.ProjectStats, error) {
	var stats models.ProjectStats

	// åŸºç¡€ç»Ÿè®¡
	if err := s.db.Model(&models.Project{}).Count(&stats.TotalProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("status = ?", "draft").Count(&stats.DraftProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("status = ?", "pending").Count(&stats.PendingProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("status = ?", "approved").Count(&stats.ApprovedProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("status = ?", "rejected").Count(&stats.RejectedProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("type = ?", "ç§‘ç ”").Count(&stats.ResearchProjects).Error; err != nil {
		return nil, err
	}

	if err := s.db.Model(&models.Project{}).Where("type = ?", "ç«èµ›").Count(&stats.CompetitionProjects).Error; err != nil {
		return nil, err
	}

	// ç±»å‹ç»Ÿè®¡
	stats.TypeStats = make(map[string]int64)
	var typeResults []struct {
		Type  string `json:"type"`
		Count int64  `json:"count"`
	}
	if err := s.db.Model(&models.Project{}).
		Select("type, count(*) as count").
		Group("type").
		Find(&typeResults).Error; err != nil {
		return nil, err
	}

	for _, result := range typeResults {
		stats.TypeStats[result.Type] = result.Count
	}

	// çŠ¶æ€ç»Ÿè®?
	stats.StatusStats = make(map[string]int64)
	var statusResults []struct {
		Status string `json:"status"`
		Count  int64  `json:"count"`
	}
	if err := s.db.Model(&models.Project{}).
		Select("status, count(*) as count").
		Group("status").
		Find(&statusResults).Error; err != nil {
		return nil, err
	}

	for _, result := range statusResults {
		stats.StatusStats[result.Status] = result.Count
	}

	// æœˆåº¦ç»Ÿè®¡ï¼ˆæœ€è¿?2ä¸ªæœˆï¼?
	stats.MonthlyStats = make(map[string]int64)
	now := time.Now()
	for i := 0; i < 12; i++ {
		month := now.AddDate(0, -i, 0)
		monthKey := month.Format("2006-01")

		var count int64
		startOfMonth := time.Date(month.Year(), month.Month(), 1, 0, 0, 0, 0, month.Location())
		endOfMonth := startOfMonth.AddDate(0, 1, 0).Add(-time.Second)

		if err := s.db.Model(&models.Project{}).
			Where("create_time BETWEEN ? AND ?", startOfMonth, endOfMonth).
			Count(&count).Error; err != nil {
			return nil, err
		}

		stats.MonthlyStats[monthKey] = count
	}

	return &stats, nil
}

// GetMyProjects è·å–æˆ‘çš„é¡¹ç›®åˆ—è¡¨
func (s *ProjectService) GetMyProjects(studentID uint, status string) ([]models.ProjectMyListResponse, error) {
	var projects []models.Project
	query := s.db.Where("student_id = ?", studentID)

	if status != "" {
		query = query.Where("status = ?", status)
	}

	err := query.Order("create_time DESC").Find(&projects).Error
	if err != nil {
		log.Printf("è·å–æˆ‘çš„é¡¹ç›®åˆ—è¡¨å¤±è´¥: %v", err)
		return nil, err
	}

	var responses []models.ProjectMyListResponse
	for _, project := range projects {
		responses = append(responses, models.ProjectMyListResponse{
			ID:        project.ID,
			Title:     project.Title,
			Type:      project.Type,
			Status:    project.Status,
			CreatedAt: project.CreatedAt,
		})
	}

	return responses, nil
}

// GetProjectsForTeacher è·å–æ•™å¸ˆæŸ¥çœ‹çš„é¡¹ç›®åˆ—è¡?
func (s *ProjectService) GetProjectsForTeacher(params models.ProjectQueryParams) ([]models.ProjectListForTeacherResponse, int64, error) {
	var projects []models.Project
	var total int64

	query := s.db.Model(&models.Project{}).Preload("Student.Profile")

	// çŠ¶æ€ç­›é€?
	if params.Status != "" {
		query = query.Where("projects.status = ?", params.Status)
	}

	// ç±»å‹ç­›é€?
	if params.Type != "" {
		query = query.Where("projects.type = ?", params.Type)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		return nil, 0, err
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Order("projects.created_at DESC").Find(&projects).Error; err != nil {
		return nil, 0, err
	}

	var responses []models.ProjectListForTeacherResponse
	for _, project := range projects {
		response := models.ProjectListForTeacherResponse{
			ID:     project.ID,
			Title:  project.Title,
			Type:   project.Type,
			Status: project.Status,
		}

		if project.Student != nil && project.Student.Profile != nil {
			response.Student.Name = project.Student.Profile.RealName
			response.Student.StudentID = project.Student.Profile.StudentID
		}

		responses = append(responses, response)
	}

	return responses, total, nil
}

// ReviewProjectWithResponse å®¡æ ¸é¡¹ç›®å¹¶è¿”å›å“åº?
func (s *ProjectService) ReviewProjectWithResponse(projectID uint, reviewerID uint, req models.ProjectReviewRequest) (*models.ProjectReviewResponse, error) {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return nil, err
	}

	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// åˆ›å»ºå®¡æ ¸è®°å½•
	review := models.ProjectReview{
		ProjectID:  projectID,
		ReviewerID: reviewerID,
		Status:     req.Status,
		Comments:   req.Comments,
	}

	if err := tx.Create(&review).Error; err != nil {
		tx.Rollback()
		log.Printf("åˆ›å»ºå®¡æ ¸è®°å½•å¤±è´¥: %v", err)
		return nil, errors.New("åˆ›å»ºå®¡æ ¸è®°å½•å¤±è´¥")
	}

	// æ›´æ–°é¡¹ç›®çŠ¶æ€?
	if err := tx.Model(&project).Update("status", req.Status).Error; err != nil {
		tx.Rollback()
		log.Printf("æ›´æ–°é¡¹ç›®çŠ¶æ€å¤±è´? %v", err)
		return nil, errors.New("æ›´æ–°é¡¹ç›®çŠ¶æ€å¤±è´?)
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return nil, errors.New("å®¡æ ¸é¡¹ç›®å¤±è´¥")
	}

	// è·å–å®¡æ ¸è€…ä¿¡æ?
	var reviewer models.User
	if err := s.db.Preload("Profile").First(&reviewer, reviewerID).Error; err != nil {
		log.Printf("è·å–å®¡æ ¸è€…ä¿¡æ¯å¤±è´? %v", err)
	}

	reviewerName := reviewer.Username
	if reviewer.Profile != nil {
		reviewerName = reviewer.Profile.RealName
	}

	return &models.ProjectReviewResponse{
		Reviewer:   reviewerName,
		ReviewTime: review.ReviewTime,
	}, nil
}

// GetProjectReviews è·å–é¡¹ç›®å®¡æ ¸è®°å½•
func (s *ProjectService) GetProjectReviews(projectID uint) ([]models.ProjectReviewRecordResponse, error) {
	var reviews []models.ProjectReview
	err := s.db.Preload("Reviewer.Profile").Where("project_id = ?", projectID).Order("review_time DESC").Find(&reviews).Error
	if err != nil {
		return nil, err
	}

	var responses []models.ProjectReviewRecordResponse
	for _, review := range reviews {
		reviewerName := review.Reviewer.Username
		if review.Reviewer.Profile != nil {
			reviewerName = review.Reviewer.Profile.RealName
		}

		responses = append(responses, models.ProjectReviewRecordResponse{
			Reviewer:   reviewerName,
			Status:     review.Status,
			Comments:   review.Comments,
			ReviewTime: review.ReviewTime,
		})
	}

	return responses, nil
}

// GetDB è·å–æ•°æ®åº“å®ä¾?
// BindStudentTeacher ç»‘å®šå­¦ç”Ÿå’Œæ•™å¸?
func (s *ProjectService) BindStudentTeacher(req models.StudentTeacherBindRequest) (*models.StudentTeacherBindResponse, error) {
	// æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ?
	var student models.User
	if err := s.db.Preload("Profile").First(&student, req.StudentID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, errors.New("å­¦ç”Ÿä¸å­˜åœ?)
		}
		return nil, err
	}

	// æ£€æŸ¥æ•™å¸ˆæ˜¯å¦å­˜åœ?
	var teacher models.User
	if err := s.db.Preload("Profile").First(&teacher, req.TeacherID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, errors.New("æ•™å¸ˆä¸å­˜åœ?)
		}
		return nil, err
	}

	// æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®?
	var existingBind models.StudentTeacher
	if err := s.db.Where("student_id = ? AND teacher_id = ?", req.StudentID, req.TeacherID).First(&existingBind).Error; err == nil {
		return nil, errors.New("è¯¥å­¦ç”Ÿå’Œæ•™å¸ˆå·²ç»ç»‘å®š")
	}

	// åˆ›å»ºç»‘å®šå…³ç³»
	bind := models.StudentTeacher{
		StudentID: req.StudentID,
		TeacherID: req.TeacherID,
	}

	if err := s.db.Create(&bind).Error; err != nil {
		log.Printf("åˆ›å»ºå­¦ç”Ÿæ•™å¸ˆç»‘å®šå¤±è´¥: %v", err)
		return nil, errors.New("åˆ›å»ºç»‘å®šå…³ç³»å¤±è´¥")
	}

	// æ„å»ºå“åº”
	response := &models.StudentTeacherBindResponse{
		ID:        bind.ID,
		StudentID: bind.StudentID,
		TeacherID: bind.TeacherID,
		BindTime:  bind.BindTime,
	}

	// æ·»åŠ å­¦ç”Ÿä¿¡æ¯
	if student.Profile != nil {
		response.Student.ID = student.ID
		response.Student.Username = student.Username
		response.Student.RealName = student.Profile.RealName
	}

	// æ·»åŠ æ•™å¸ˆä¿¡æ¯
	if teacher.Profile != nil {
		response.Teacher.ID = teacher.ID
		response.Teacher.Username = teacher.Username
		response.Teacher.RealName = teacher.Profile.RealName
	}

	log.Printf("å­¦ç”Ÿæ•™å¸ˆç»‘å®šæˆåŠŸ - å­¦ç”ŸID: %d, æ•™å¸ˆID: %d", req.StudentID, req.TeacherID)
	return response, nil
}

// GetTeacherList è·å–æ•™å¸ˆåˆ—è¡¨
func (s *ProjectService) GetTeacherList() ([]models.TeacherListResponse, error) {
	var teachers []models.User
	err := s.db.Preload("Profile").
		Joins("JOIN user_roles ur ON users.id = ur.user_id").
		Joins("JOIN roles r ON ur.role_id = r.id").
		Where("r.role_key = ?", "teacher").
		Where("users.status = ?", "active").
		Find(&teachers).Error

	if err != nil {
		log.Printf("è·å–æ•™å¸ˆåˆ—è¡¨å¤±è´¥: %v", err)
		return nil, err
	}

	var responses []models.TeacherListResponse
	for _, teacher := range teachers {
		response := models.TeacherListResponse{
			ID:       teacher.ID,
			Username: teacher.Username,
			Email:    teacher.Email,
		}

		if teacher.Profile != nil {
			response.RealName = teacher.Profile.RealName
			response.Phone = teacher.Profile.Phone
			response.Department = teacher.Profile.Department
			response.Bio = teacher.Profile.Bio
		}

		responses = append(responses, response)
	}

	return responses, nil
}

// GetStudentTeachers è·å–å­¦ç”Ÿçš„æŒ‡å¯¼æ•™å¸ˆåˆ—è¡?
func (s *ProjectService) GetStudentTeachers(studentID uint) ([]models.TeacherListResponse, error) {
	var teachers []models.User
	err := s.db.Preload("Profile").
		Joins("JOIN student_teacher st ON users.id = st.teacher_id").
		Where("st.student_id = ?", studentID).
		Where("users.status = ?", "active").
		Find(&teachers).Error

	if err != nil {
		log.Printf("è·å–å­¦ç”ŸæŒ‡å¯¼æ•™å¸ˆåˆ—è¡¨å¤±è´¥: %v", err)
		return nil, err
	}

	var responses []models.TeacherListResponse
	for _, teacher := range teachers {
		response := models.TeacherListResponse{
			ID:       teacher.ID,
			Username: teacher.Username,
			Email:    teacher.Email,
		}

		if teacher.Profile != nil {
			response.RealName = teacher.Profile.RealName
			response.Phone = teacher.Profile.Phone
			response.Department = teacher.Profile.Department
			response.Bio = teacher.Profile.Bio
		}

		responses = append(responses, response)
	}

	return responses, nil
}

// SubmitProject æäº¤é¡¹ç›®å®¡æ ¸
func (s *ProjectService) SubmitProject(projectID, studentID uint) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// æ£€æŸ¥æƒé™ï¼šåªæœ‰é¡¹ç›®åˆ›å»ºè€…å¯ä»¥æäº?
	if project.StudentID != studentID {
		return errors.New("æ— æƒé™æäº¤æ­¤é¡¹ç›®")
	}

	// æ£€æŸ¥çŠ¶æ€ï¼šåªæœ‰è‰ç¨¿çŠ¶æ€çš„é¡¹ç›®å¯ä»¥æäº¤
	if project.Status != "draft" {
		return errors.New("åªæœ‰è‰ç¨¿çŠ¶æ€çš„é¡¹ç›®å¯ä»¥æäº¤")
	}

	// æ›´æ–°é¡¹ç›®çŠ¶æ€å’Œæäº¤æ—¶é—´
	now := time.Now()
	updates := map[string]interface{}{
		"status":       "pending",
		"submitted_at": &now,
	}

	if err := s.db.Model(&project).Updates(updates).Error; err != nil {
		log.Printf("æäº¤é¡¹ç›®å¤±è´¥: %v", err)
		return errors.New("æäº¤é¡¹ç›®å¤±è´¥")
	}

	log.Printf("é¡¹ç›®æäº¤æˆåŠŸ - é¡¹ç›®ID: %d", projectID)
	return nil
}

// UnbindStudentTeacher è§£ç»‘å­¦ç”Ÿå’Œæ•™å¸?
func (s *ProjectService) UnbindStudentTeacher(studentID, teacherID uint) error {
	result := s.db.Where("student_id = ? AND teacher_id = ?", studentID, teacherID).Delete(&models.StudentTeacher{})
	if result.Error != nil {
		log.Printf("è§£ç»‘å­¦ç”Ÿæ•™å¸ˆå¤±è´¥: %v", result.Error)
		return errors.New("è§£ç»‘å¤±è´¥")
	}

	if result.RowsAffected == 0 {
		return errors.New("ç»‘å®šå…³ç³»ä¸å­˜åœ?)
	}

	log.Printf("å­¦ç”Ÿæ•™å¸ˆè§£ç»‘æˆåŠŸ - å­¦ç”ŸID: %d, æ•™å¸ˆID: %d", studentID, teacherID)
	return nil
}

func (s *ProjectService) GetDB() *gorm.DB {
	return s.db
}

// GetTeacherProjects è·å–å½“å‰ç™»å½•æ•™å¸ˆçš„æ‰€æœ‰æŒ‡å¯¼é¡¹ç›?
func (s *ProjectService) GetTeacherProjects(teacherID uint, params models.TeacherProjectQueryParams) ([]models.TeacherProjectResponse, int64, error) {
	var projects []models.Project
	var total int64

	// æ„å»ºæŸ¥è¯¢ - åªæŸ¥è¯¢è¯¥æ•™å¸ˆæŒ‡å¯¼çš„é¡¹ç›?
	query := s.db.Model(&models.Project{}).
		Preload("Student.Profile").
		Preload("Members").
		Preload("Files").
		Preload("Reviews").
		Where("projects.teacher_id = ?", teacherID)

	// æœç´¢æ¡ä»¶
	if params.Search != "" {
		search := "%" + params.Search + "%"
		query = query.Where("projects.title LIKE ? OR projects.description LIKE ?", search, search)
	}

	// ç±»å‹ç­›é€?
	if params.Type != "" {
		query = query.Where("projects.type = ?", params.Type)
	}

	// çŠ¶æ€ç­›é€?
	if params.Status != "" {
		query = query.Where("projects.status = ?", params.Status)
	}

	// å­¦ç”ŸIDç­›é€?
	if params.StudentID > 0 {
		query = query.Where("projects.student_id = ?", params.StudentID)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		log.Printf("è·å–æ•™å¸ˆé¡¹ç›®æ€»æ•°å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// æ’åº
	if params.SortBy != "" {
		order := params.SortBy
		if params.SortOrder == "desc" {
			order += " DESC"
		}
		query = query.Order(order)
	} else {
		query = query.Order("projects.created_at DESC")
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Find(&projects).Error; err != nil {
		log.Printf("æŸ¥è¯¢æ•™å¸ˆé¡¹ç›®åˆ—è¡¨å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// è½¬æ¢ä¸ºå“åº”æ ¼å¼?
	var responses []models.TeacherProjectResponse
	for _, project := range projects {
		response := models.TeacherProjectResponse{
			ID:          project.ID,
			Title:       project.Title,
			Description: project.Description,
			Type:        project.Type,
			Status:      project.Status,
			SubmittedAt: project.SubmittedAt,
			CreatedAt:   project.CreatedAt,
			UpdatedAt:   project.UpdatedAt,
			MemberCount: len(project.Members),
			FileCount:   len(project.Files),
			ReviewCount: len(project.Reviews),
		}

		// å¡«å……å­¦ç”Ÿä¿¡æ¯
		if project.Student != nil && project.Student.Profile != nil {
			response.Student.ID = project.Student.ID
			response.Student.Username = project.Student.Username
			response.Student.RealName = project.Student.Profile.RealName
			response.Student.Email = project.Student.Email
			response.Student.Phone = project.Student.Profile.Phone
			response.Student.Department = project.Student.Profile.Department
			response.Student.StudentID = project.Student.Profile.StudentID
		}

		responses = append(responses, response)
	}

	return responses, total, nil
}

// GetTeacherListWithFilter è·å–æ•™å¸ˆåˆ—è¡¨ï¼ˆæ”¯æŒé™¢ç³»ç­›é€‰ï¼‰
func (s *ProjectService) GetTeacherListWithFilter(params models.TeacherQueryParams) ([]models.TeacherListResponse, int64, error) {
	var users []models.User
	var total int64

	// æ„å»ºæŸ¥è¯¢ - åªæŸ¥è¯¢æ•™å¸ˆè§’è‰²çš„ç”¨æˆ·
	query := s.db.Model(&models.User{}).
		Joins("JOIN user_roles ur ON users.id = ur.user_id").
		Joins("JOIN roles r ON ur.role_id = r.id").
		Preload("Profile").
		Where("r.role_key = ?", "teacher").
		Where("users.status = ?", "active")

	// æœç´¢æ¡ä»¶
	if params.Search != "" {
		search := "%" + params.Search + "%"
		query = query.Where("users.username LIKE ? OR user_profiles.real_name LIKE ?", search, search)
	}

	// é™¢ç³»ç­›é€?
	if params.Department != "" {
		query = query.Where("user_profiles.department = ?", params.Department)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		log.Printf("è·å–æ•™å¸ˆæ€»æ•°å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// æ’åº
	if params.SortBy != "" {
		order := params.SortBy
		if params.SortOrder == "desc" {
			order += " DESC"
		}
		query = query.Order(order)
	} else {
		query = query.Order("users.create_time DESC")
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Find(&users).Error; err != nil {
		log.Printf("æŸ¥è¯¢æ•™å¸ˆåˆ—è¡¨å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// è½¬æ¢ä¸ºå“åº”æ ¼å¼?
	var responses []models.TeacherListResponse
	for _, user := range users {
		response := models.TeacherListResponse{
			ID:         user.ID,
			Username:   user.Username,
			RealName:   "",
			Email:      user.Email,
			Phone:      "",
			Department: "",
			Bio:        "",
		}

		if user.Profile != nil {
			response.RealName = user.Profile.RealName
			response.Phone = user.Profile.Phone
			response.Department = user.Profile.Department
			response.Bio = user.Profile.Bio
		}

		responses = append(responses, response)
	}

	return responses, total, nil
}

// BindStudentToTeacher å­¦ç”Ÿç»‘å®šæ•™å¸ˆï¼ˆå­¦ç”Ÿç«¯æ¥å£ï¼?
func (s *ProjectService) BindStudentToTeacher(studentID uint, req models.StudentBindTeacherRequest) (*models.StudentBindTeacherResponse, error) {
	// æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ?
	var student models.User
	if err := s.db.Preload("Profile").First(&student, studentID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return nil, errors.New("å­¦ç”Ÿä¸å­˜åœ?)
		}
		return nil, err
	}

	// æ£€æŸ¥æ•™å¸ˆæ˜¯å¦å­˜åœ¨ä¸”æ˜¯æ•™å¸ˆè§’è‰?
	var teacher models.User
	if err := s.db.Preload("Profile").
		Joins("JOIN user_roles ur ON users.id = ur.user_id").
		Joins("JOIN roles r ON ur.role_id = r.id").
		Where("r.role_key = ? AND users.id = ?", "teacher", req.TeacherID).
		First(&teacher).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return nil, errors.New("æ•™å¸ˆä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•™å¸ˆè§’è‰²")
		}
		return nil, err
	}

	// æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®?
	var existingBind models.StudentTeacher
	if err := s.db.Where("student_id = ? AND teacher_id = ?", studentID, req.TeacherID).First(&existingBind).Error; err == nil {
		return nil, errors.New("è¯¥å­¦ç”Ÿå·²ç»ç»‘å®šæ­¤æ•™å¸ˆ")
	}

	// åˆ›å»ºç»‘å®šå…³ç³»
	studentTeacher := models.StudentTeacher{
		StudentID: studentID,
		TeacherID: req.TeacherID,
		BindTime:  time.Now(),
	}

	if err := s.db.Create(&studentTeacher).Error; err != nil {
		log.Printf("åˆ›å»ºå­¦ç”Ÿæ•™å¸ˆç»‘å®šå¤±è´¥: %v", err)
		return nil, err
	}

	// æ„å»ºå“åº”
	response := &models.StudentBindTeacherResponse{
		ID:        studentTeacher.ID,
		StudentID: studentTeacher.StudentID,
		TeacherID: studentTeacher.TeacherID,
		BindTime:  studentTeacher.BindTime,
	}

	// å¡«å……æ•™å¸ˆä¿¡æ¯
	response.Teacher.ID = teacher.ID
	response.Teacher.Username = teacher.Username
	response.Teacher.Email = teacher.Email
	if teacher.Profile != nil {
		response.Teacher.RealName = teacher.Profile.RealName
		response.Teacher.Phone = teacher.Profile.Phone
		response.Teacher.Department = teacher.Profile.Department
		response.Teacher.Bio = teacher.Profile.Bio
	}

	return response, nil
}

// ValidateProjectUpdate éªŒè¯é¡¹ç›®æ›´æ–°æƒé™ï¼ˆé¡¹ç›®æäº¤åç¦æ­¢ä¿®æ”¹æŒ‡å¯¼è€å¸ˆï¼?
func (s *ProjectService) ValidateProjectUpdate(projectID uint, studentID uint) error {
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å±äºè¯¥å­¦ç”Ÿ
	if project.StudentID != studentID {
		return errors.New("æ— æƒä¿®æ”¹æ­¤é¡¹ç›?)
	}

	// æ£€æŸ¥é¡¹ç›®çŠ¶æ€ï¼Œå·²æäº¤çš„é¡¹ç›®ä¸èƒ½ä¿®æ”¹æŒ‡å¯¼è€å¸ˆ
	if project.Status != "draft" {
		return errors.New("é¡¹ç›®å·²æäº¤ï¼Œæ— æ³•ä¿®æ”¹æŒ‡å¯¼è€å¸ˆ")
	}

	return nil
}

// GetMyStudents è·å–æŒ‡å®šæ•™å¸ˆæŒ‡å¯¼çš„å­¦ç”Ÿåˆ—è¡?
func (s *ProjectService) GetMyStudents(teacherID uint, params models.TeacherQueryParams) ([]models.TeacherListResponse, int64, error) {
	var users []models.User
	var total int64

	// æ„å»ºæŸ¥è¯¢ - æŸ¥è¯¢ç»‘å®šåˆ°è¯¥æ•™å¸ˆçš„å­¦ç”?
	query := s.db.Model(&models.User{}).
		Joins("JOIN student_teacher st ON users.id = st.student_id").
		Joins("JOIN user_roles ur ON users.id = ur.user_id").
		Joins("JOIN roles r ON ur.role_id = r.id").
		Preload("Profile").
		Where("st.teacher_id = ?", teacherID).
		Where("r.role_key = ?", "student").
		Where("users.status = ?", "active")

	// æœç´¢æ¡ä»¶
	if params.Search != "" {
		search := "%" + params.Search + "%"
		query = query.Where("users.username LIKE ? OR user_profiles.real_name LIKE ?", search, search)
	}

	// é™¢ç³»ç­›é€?
	if params.Department != "" {
		query = query.Where("user_profiles.department = ?", params.Department)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		log.Printf("è·å–æ•™å¸ˆå­¦ç”Ÿæ€»æ•°å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// æ’åº
	if params.SortBy != "" {
		order := params.SortBy
		if params.SortOrder == "desc" {
			order += " DESC"
		}
		query = query.Order(order)
	} else {
		query = query.Order("users.create_time DESC")
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Find(&users).Error; err != nil {
		log.Printf("æŸ¥è¯¢æ•™å¸ˆå­¦ç”Ÿåˆ—è¡¨å¤±è´¥: %v", err)
		return nil, 0, err
	}

	// è½¬æ¢ä¸ºå“åº”æ ¼å¼?
	var responses []models.TeacherListResponse
	for _, user := range users {
		response := models.TeacherListResponse{
			ID:         user.ID,
			Username:   user.Username,
			RealName:   "",
			Email:      user.Email,
			Phone:      "",
			Department: "",
			Bio:        "",
		}

		if user.Profile != nil {
			response.RealName = user.Profile.RealName
			response.Phone = user.Profile.Phone
			response.Department = user.Profile.Department
			response.Bio = user.Profile.Bio
		}

		responses = append(responses, response)
	}

	return responses, total, nil
}

// ForceUpdateProjectStatus ç®¡ç†å‘˜å¼ºåˆ¶æ›´æ–°é¡¹ç›®çŠ¶æ€?
func (s *ProjectService) ForceUpdateProjectStatus(projectID uint, status string, reason string, operatorID uint) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// å¼€å§‹äº‹åŠ?
	tx := s.db.Begin()
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// æ›´æ–°é¡¹ç›®çŠ¶æ€?
	updates := map[string]interface{}{
		"status":              status,
		"force_status_reason": reason,
		"updated_at":          time.Now(),
	}
	if err := tx.Model(&project).Updates(updates).Error; err != nil {
		tx.Rollback()
		return err
	}

	// åˆ›å»ºå®¡æ ¸è®°å½•
	review := models.ProjectReview{
		ProjectID:  projectID,
		ReviewerID: operatorID,
		Status:     status,
		Comments:   "ç®¡ç†å‘˜å¼ºåˆ¶æ“ä½? " + reason,
		IsForce:    true,
	}
	if err := tx.Create(&review).Error; err != nil {
		tx.Rollback()
		return err
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		return err
	}

	log.Printf("ç®¡ç†å‘?%d å¼ºåˆ¶æ›´æ–°é¡¹ç›® %d çŠ¶æ€ä¸º %sï¼ŒåŸå›? %s", operatorID, projectID, status, reason)
	return nil
}

// SoftDeleteProject è½¯åˆ é™¤é¡¹ç›?
func (s *ProjectService) SoftDeleteProject(projectID uint, operatorID uint) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ?
	var project models.Project
	if err := s.db.First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	// æ£€æŸ¥æ“ä½œæƒé™ï¼ˆåªæœ‰é¡¹ç›®åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯ä»¥è½¯åˆ é™¤ï¼?
	if project.CreatedBy != operatorID {
		// æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘?
		var user models.User
		if err := s.db.Preload("Roles").First(&user, operatorID).Error; err != nil {
			return errors.New("ç”¨æˆ·ä¸å­˜åœ?)
		}

		isAdmin := false
		for _, role := range user.Roles {
			if role.RoleKey == "admin" {
				isAdmin = true
				break
			}
		}

		if !isAdmin {
			return errors.New("åªæœ‰é¡¹ç›®åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤é¡¹ç›?)
		}
	}

	// è½¯åˆ é™¤é¡¹ç›?
	updates := map[string]interface{}{
		"deleted":    true,
		"updated_at": time.Now(),
	}
	if err := s.db.Model(&project).Updates(updates).Error; err != nil {
		return err
	}

	log.Printf("ç”¨æˆ· %d è½¯åˆ é™¤é¡¹ç›?%d", operatorID, projectID)
	return nil
}

// RestoreProject æ¢å¤è½¯åˆ é™¤çš„é¡¹ç›®
func (s *ProjectService) RestoreProject(projectID uint, operatorID uint) error {
	// æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨ä¸”å·²è¢«è½¯åˆ é™?
	var project models.Project
	if err := s.db.Unscoped().First(&project, projectID).Error; err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return errors.New("é¡¹ç›®ä¸å­˜åœ?)
		}
		return err
	}

	if !project.Deleted {
		return errors.New("é¡¹ç›®æœªè¢«åˆ é™¤")
	}

	// æ£€æŸ¥æ“ä½œæƒé™ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ¢å¤ï¼‰
	var user models.User
	if err := s.db.Preload("Roles").First(&user, operatorID).Error; err != nil {
		return errors.New("ç”¨æˆ·ä¸å­˜åœ?)
	}

	isAdmin := false
	for _, role := range user.Roles {
		if role.RoleKey == "admin" {
			isAdmin = true
			break
		}
	}

	if !isAdmin {
		return errors.New("åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ¢å¤é¡¹ç›?)
	}

	// æ¢å¤é¡¹ç›®
	updates := map[string]interface{}{
		"deleted":    false,
		"updated_at": time.Now(),
	}
	if err := s.db.Model(&project).Updates(updates).Error; err != nil {
		return err
	}

	log.Printf("ç®¡ç†å‘?%d æ¢å¤é¡¹ç›® %d", operatorID, projectID)
	return nil
}

// GetProjectTypes è·å–é¡¹ç›®åˆ†ç±»åˆ—è¡¨
func (s *ProjectService) GetProjectTypes() ([]models.ProjectType, error) {
	var projectTypes []models.ProjectType
	if err := s.db.Find(&projectTypes).Error; err != nil {
		return nil, err
	}
	return projectTypes, nil
}

// GetProjectsByCategory æ ¹æ®åˆ†ç±»è·å–é¡¹ç›®åˆ—è¡¨
func (s *ProjectService) GetProjectsByCategory(categoryID uint, params models.ProjectQueryParams) ([]models.ProjectListResponse, int64, error) {
	var projects []models.Project
	var total int64

	// æ„å»ºæŸ¥è¯¢
	query := s.db.Model(&models.Project{}).
		Where("category_id = ? AND deleted = false", categoryID).
		Preload("Student.Profile").
		Preload("Teacher.Profile").
		Preload("Category").
		Preload("Members").
		Preload("Files").
		Preload("Reviews")

	// æœç´¢æ¡ä»¶
	if params.Search != "" {
		search := "%" + params.Search + "%"
		query = query.Where("projects.title LIKE ? OR projects.description LIKE ?", search, search)
	}

	// ç±»å‹ç­›é€?
	if params.Type != "" {
		query = query.Where("projects.type = ?", params.Type)
	}

	// çŠ¶æ€ç­›é€?
	if params.Status != "" {
		query = query.Where("projects.status = ?", params.Status)
	}

	// è·å–æ€»æ•°
	if err := query.Count(&total).Error; err != nil {
		return nil, 0, err
	}

	// æ’åº
	if params.SortBy != "" {
		order := params.SortBy
		if params.SortOrder == "desc" {
			order += " DESC"
		}
		query = query.Order(order)
	} else {
		query = query.Order("projects.created_at DESC")
	}

	// åˆ†é¡µ
	if params.Page > 0 && params.Size > 0 {
		offset := (params.Page - 1) * params.Size
		query = query.Offset(offset).Limit(params.Size)
	}

	// æ‰§è¡ŒæŸ¥è¯¢
	if err := query.Find(&projects).Error; err != nil {
		return nil, 0, err
	}

	// è½¬æ¢ä¸ºå“åº”æ ¼å¼?
	var responses []models.ProjectListResponse
	for _, project := range projects {
		response := models.ProjectListResponse{
			ID:          project.ID,
			Title:       project.Title,
			Description: project.Description,
			Type:        project.Type,
			Status:      project.Status,
			TeacherID:   project.TeacherID,
			SubmittedAt: project.SubmittedAt,
			CreatedAt:   project.CreatedAt,
			UpdatedAt:   project.UpdatedAt,
			MemberCount: len(project.Members),
			FileCount:   len(project.Files),
			ReviewCount: len(project.Reviews),
		}

		// æ·»åŠ å­¦ç”Ÿå’Œæ•™å¸ˆä¿¡æ?
		if project.Student != nil && project.Student.Profile != nil {
			response.StudentName = project.Student.Profile.RealName
			response.StudentID = project.Student.Profile.StudentID
		}
		if project.Teacher != nil && project.Teacher.Profile != nil {
			response.TeacherName = project.Teacher.Profile.RealName
		}

		responses = append(responses, response)
	}

	return responses, total, nil
}
